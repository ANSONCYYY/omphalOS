apiVersion: batch/v1
kind: CronJob
metadata:
  name: omphalos-nightly
  namespace: omphalos
spec:
  schedule: "0 3 * * *"
  concurrencyPolicy: Forbid
  jobTemplate:
    spec:
      backoffLimit: 0
      template:
        spec:
          serviceAccountName: omphalos
          restartPolicy: Never
          containers:
            - name: omphalos
              image: omphalos:latest
              imagePullPolicy: IfNotPresent
              command: ["sh", "-lc"]
              args:
                - "mkdir -p /var/omphalos/runs && RUN_DIR=$(omphalos run --config /etc/omphalos/example_run.yaml) && omphalos verify --run-dir ${RUN_DIR}"
              volumeMounts:
                - name: cfg
                  mountPath: /etc/omphalos
                - name: runs
                  mountPath: /var/omphalos/runs
          volumes:
            - name: cfg
              configMap:
                name: omphalos-config
            - name: runs
              persistentVolumeClaim:
                claimName: omphalos-runs
